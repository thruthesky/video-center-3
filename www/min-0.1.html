<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebRTC Peer Connection</title>
    <script src="js/jquery-2.2.3.min.js"></script>
    <script src="js/underscore.string.min.js"></script>

    <style>
        video {
            object-fit: fill;
            width: 99%;
        }
    </style>
</head>
<body>

<script src="https://www.withcenter.com:10443/dist/rmc3.js"></script>
<script src="https://www.withcenter.com:10443/dist/rmc3.fbr.js"></script>

<!-- socket.io for signaling -->
<script src="https://www.withcenter.com:10443/socket.io/socket.io.js"></script>

<hr>
<input type="text" id="room-id" value="abcdef">
<button id="open-room">Open Room</button>
<button id="join-room">Join Room</button>
<button id="open-or-join-room">Auto Open Or Join Room</button>
<hr>
<button id="get-public-moderators">getPublicModerators</button>
<hr>
<div id="chat-container">
    <input type="text" id="input-text-chat" placeholder="Enter Text Chat" disabled>
    <button id="share-file" disabled>Share File</button>
    <br>
    <div id="file-container"></div>
    <div class="chat-output"></div>
</div>
<hr>

<script>
    // ......................................................
    // .......................UI Code........................
    // ......................................................
    /*
    document.getElementById('open-room').onclick = function() {
        this.disabled = true;
        connection.open(document.getElementById('room-id').value);
    };
    */
    var el = {};
    el.open_room = $('#open-room');
    el.join_room = $('#join-room');
    el.open_or_join_room = $('#open-or-join-room');
    el.room_id = $('#room-id');
    function getRoomID() {
        return el.room_id.val();
    }
    el.disable = function( $this ) {
        $this.prop('disabled', true);
    };


    el.open_room.click(function(){
        console.log('open room : ' + getRoomID() );
        el.disable( $(this) );
        connection.open( getRoomID() );
    });
    el.join_room.click( function() {
        el.disable( $(this) );
        connection.join( getRoomID() );
    });
    el.open_or_join_room.click( function() {
        el.disable( $(this) );
        connection.openOrJoin( getRoomID() );
    });


    // ......................................................
    // ................FileSharing/TextChat Code.............
    // ......................................................
    document.getElementById('share-file').onclick = function() {
        var fileSelector = new FileSelector();
        fileSelector.selectSingleFile(function(file) {
            connection.send(file);
        });
    };
    document.getElementById('input-text-chat').onkeyup = function(e) {
        if(e.keyCode != 13) return;

        // removing trailing/leading whitespace
        this.value = this.value.replace(/^\s+|\s+$/g, '');
        if (!this.value.length) return;

        connection.send(this.value);
        appendDIV(this.value);
        this.value =  '';
    };
    var chatContainer = document.querySelector('.chat-output');
    function appendDIV(event) {
        var div = document.createElement('div');
        div.innerHTML = event.data || event;
        chatContainer.insertBefore(div, chatContainer.firstChild);
        div.tabIndex = 0; div.focus();

        document.getElementById('input-text-chat').focus();
    }
    // ......................................................
    // ..................RTCMultiConnection Code.............
    // ......................................................
    var connection = new RTCMultiConnection();
    connection.socketURL = '//www.withcenter.com:10443/';
    connection.enableFileSharing = true; // by default, it is "false".
    connection.session = {
        audio: true,
        video: true,
        data : true
    };
    connection.sdpConstraints.mandatory = {
        OfferToReceiveAudio: true,
        OfferToReceiveVideo: true
    };

    /**
     *
     * @param event
     */
    connection.onstream = function(event) {
        var video = event.mediaElement;
        var $v = $(video);
        $v.prop('controls', false);
        $('body').append($v);
    };

    connection.onmessage = appendDIV;
    connection.filesContainer = document.getElementById('file-container');
    connection.onopen = function() {
        console.log('connection.onopen : ' + getRoomID() );
        document.getElementById('share-file').disabled      = false;
        document.getElementById('input-text-chat').disabled = false;
    };
    
</script>

</body>
</html>